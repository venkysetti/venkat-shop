{% extends 'theme.html' %}
{% load static %}

{% block main %}
<style>
/* styles same as your file */
body{background:#f4f6fa;font-family:'Montserrat',sans-serif;color:#333}
.cart-main{display:flex;flex-wrap:wrap;gap:2rem;max-width:1200px;margin:40px auto}
.cart-left{flex:2;background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.05);padding:32px}
.cart-right{flex:1;background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.05);padding:32px;height:fit-content}
.cart-product{display:flex;gap:20px;align-items:center;border-bottom:1px solid #ececec;padding-bottom:16px;margin-bottom:20px}
.cart-product-img img{width:120px;border-radius:10px;object-fit:contain;background:#f4f6fa}
.cart-product-details{flex:1}
.cart-product-title{font-weight:bold;font-size:1.3rem;margin-bottom:6px}
.cart-product-meta{color:#888;font-size:0.98rem}
.cart-product-price{color:#08a045;font-weight:bold;font-size:1.2rem}
.item-quantity form{display:flex;align-items:center;gap:8px;margin-top:8px}
.item-quantity button{background:#ff8300;border:none;color:#fff;font-weight:bold;padding:4px 10px;cursor:pointer;border-radius:4px;font-size:1.2rem;line-height:1}
.item-quantity input{width:40px;text-align:center;font-size:1rem;border:1px solid #ccc;border-radius:4px;background:#fff}
.cart-placeorder{margin-top:36px;width:100%;background:#ff8300;color:#fff;font-size:1.25rem;font-weight:bold;border:none;border-radius:7px;padding:15px 0;cursor:pointer;letter-spacing:0.8px;transition:background 0.2s}
.cart-placeorder:hover{background:#ff6f00}
.cart-additional{margin-top:24px;background:#f6faff;border-radius:8px;padding:18px 20px;display:flex;align-items:flex-start}
.cart-add-img{margin-right:18px}
.cart-add-btn{background:#ff8300;color:#fff;border:none;border-radius:6px;padding:10px 20px;font-weight:bold;margin-left:auto;margin-top:8px;cursor:pointer;text-decoration:none;display:inline-block}
.cart-summary-title{font-weight:bold;font-size:1.1rem;margin-bottom:16px;color:#444}
.cart-summary-row{display:flex;justify-content:space-between;margin-bottom:10px;font-size:1.08rem}
.cart-summary-total{color:#08a045;font-size:1.25rem;font-weight:bold;margin-top:16px;display:flex;justify-content:space-between}
.cart-summary-savings{color:#20b526;margin-top:12px;font-size:1rem;font-weight:600}
.cart-summary-safe{margin-top:18px;color:#666;font-size:0.96rem}
</style>

<div class="cart-main">
  <div class="cart-left">
    <div class="cart-pincode-box">
      <input type="text" class="cart-pincode-input" placeholder="Enter Delivery Pincode">
    </div>

    {% for item in cart_items %}
    <div class="cart-product">
      <div class="cart-product-img">
        <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}">
      </div>
      <div class="cart-product-details">
        <div class="cart-product-title">{{ item.product.name }}</div>
        <div class="cart-product-meta">Seller: {{ item.product.seller|default:"Unknown" }}</div>
        <div style="margin:6px 0;">
          <span class="cart-product-price">₹{{ item.product.price }}</span>
        </div>
        <div class="item-quantity">
          <form method="post" action="{% url 'update_cart' %}">
            {% csrf_token %}
            <input type="hidden" name="item_id" value="{{ item.id }}">
            <button type="submit" name="action" value="decrement">−</button>
            <input type="text" name="quantity" value="{{ item.quantity }}" readonly>
            <button type="submit" name="action" value="increment">+</button>
          </form>
        </div>
      </div>
    </div>
    {% empty %}
    <p>No items in your cart.</p>
    {% endfor %}

    <div class="cart-additional">
      <div class="cart-add-img">
        <img src="{% static 'images/screen-care-plan.png' %}" width="48" style="border-radius:7px;">
      </div>
      <div>
        <a href="{% url 'home' %}" class="cart-add-btn">Add Item</a>
      </div>
    </div>

    <button id="placeOrderBtn" class="cart-placeorder">PLACE ORDER</button>

    <script>
      function getCookie(name){
        let cookieValue=null;
        if(document.cookie && document.cookie!==''){
          const cookies=document.cookie.split(';');
          for(let i=0;i<cookies.length;i++){
            const cookie=cookies[i].trim();
            if(cookie.substring(0,name.length+1)===(name+'=')){
              cookieValue=decodeURIComponent(cookie.substring(name.length+1));
              break;
            }
          }
        }
        return cookieValue;
      }

      document.getElementById('placeOrderBtn').addEventListener('click', async function(){
        const btn=this;
        btn.disabled=true;
        btn.textContent='Placing...';
        try{
          const resp=await fetch("{% url 'place_order' %}",{
            method:'POST',
            credentials:'same-origin',
            headers:{
              'X-CSRFToken': getCookie('csrftoken'),
              'X-Requested-With':'XMLHttpRequest',
            }
          });
          let data=null;
          try{ data=await resp.json(); }catch(e){}
          if(resp.status===401){
            window.location.href="{% url 'login' %}?next={% url 'cart' %}";
            return;
          }
          if(resp.status===403){
            alert('CSRF failed. Refresh the page and try again.');
            return;
          }
          if(!resp.ok || !data || !data.ok){
            alert((data && data.error) || 'Could not place order');
            return;
          }
          const modalEl=document.getElementById('orderSuccessModal');
          const modal=new bootstrap.Modal(modalEl);
          modal.show();
          modalEl.addEventListener('hidden.bs.modal',()=>{ window.location.reload(); },{once:true});
        }catch(e){
          alert('Something went wrong. Please try again.');
        }finally{
          btn.disabled=false;
          btn.textContent='PLACE ORDER';
        }
      });
    </script>
  </div>

  <div class="cart-right">
    <div class="cart-summary-title">PRICE DETAILS</div>
    <div class="cart-summary-row">
      <span>Price ({{ cart_items|length }} item{% if cart_items|length != 1 %}s{% endif %})</span>
      <span>₹{{ original_total }}</span>
    </div>
    <div class="cart-summary-row">
      <span>Discount(10%)</span>
      <span style="color:#20b526;">-₹{{ discount_total }}</span>
    </div>
    <div class="cart-summary-row">
      <span>Protect Promise Fee</span>
      <span>₹{{ promise_fee_total }}</span>
    </div>
    <div class="cart-summary-total">
      <span>Total Amount</span>
      <span>₹{{ final_total }}</span>
    </div>
    <div class="cart-summary-savings">
      You will save ₹{{ savings_total }} on this order
    </div>
    <div class="cart-summary-safe">
      <span>Safe and Secure Payments. Easy returns. 100% Authentic products.</span>
    </div>
  </div>
</div>

<div class="modal fade" id="orderSuccessModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content" style="min-height:50vh;">
      <div class="modal-header border-0">
        <h5 class="modal-title">Order Successful</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body d-flex flex-column justify-content-center align-items-center text-center">
        <img src="{% static 'images/check.png' %}" alt="" width="72" class="mb-3">
        <h4 class="mb-2">Thanks for your purchase!</h4>
        <p class="text-muted">A confirmation has been recorded. Continue shopping or view your orders.</p>
        <div class="mt-3">
          <a href="{% url 'home' %}" class="btn btn-primary me-2">Continue shopping</a>
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
